<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Money OS</title>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Money OS">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0b0b0c">

  <style>
    :root{
      --bg:#0b0b0c;
      --card:#14141b;
      --card2:#101017;
      --stroke:#262633;
      --text:#f2f2f2;
      --muted:#b6b6c2;

      --accent:#7c5cff;
      --accent2:#2dd4bf;

      --ok:#2dd4bf;
      --warn:#fbbf24;
      --bad:#fb7185;

      --shadow: 0 12px 28px rgba(0,0,0,.38);
      --radius:16px;

      --navH: 78px; /* base nav height; real includes safe-area inset bottom */
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:
        radial-gradient(900px 520px at 10% -10%, rgba(124,92,255,.24), transparent 62%),
        radial-gradient(760px 420px at 92% 0%, rgba(45,212,191,.14), transparent 56%),
        var(--bg);
      color:var(--text);
      font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial;
    }

    /* ===== Layout that fixes ‚Äúcut off‚Äù + blank lower third ===== */
    .app{
      min-height: 100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(to bottom, rgba(11,11,12,.92), rgba(11,11,12,.65));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(38,38,51,.6);
      padding: calc(10px + env(safe-area-inset-top)) 16px 10px 16px;
    }

    .headWrap{
      max-width:980px; margin:0 auto;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }

    .brand{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    h1{ margin:0; font-size:16px; letter-spacing:.2px; }
    .sub{ color:var(--muted); font-size:12px; }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight:900;
      border:1px solid rgba(38,38,51,.9);
      background: rgba(15,15,18,.9);
      color: var(--muted);
      white-space: nowrap;
      max-width: 60vw;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .pill.ok{ color:#06251f; background: rgba(45,212,191,.95); border-color: rgba(45,212,191,.5); }
    .pill.warn{ color:#2b1d00; background: rgba(251,191,36,.95); border-color: rgba(251,191,36,.5); }
    .pill.bad{ color:#2b0b12; background: rgba(251,113,133,.95); border-color: rgba(251,113,133,.5); }

    main{
      flex:1;
      display:flex;
      justify-content:center;
    }

    .wrap{
      width: 100%;
      max-width: 980px;
      padding: 14px 16px calc(var(--navH) + env(safe-area-inset-bottom) + 14px);
    }

    /* Pages now fill available area without weird blank space */
    .page{ display:none; }
    .page.active{ display:block; }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 12px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(20,20,27,.92), rgba(16,16,23,.92));
      border: 1px solid rgba(38,38,51,.9);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0 0 10px;
      font-size: 13px;
      color: rgba(242,242,242,.9);
      letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between;
    }

    .muted{ color:var(--muted); font-size:12px; }
    .big{ font-size:22px; font-weight:900; letter-spacing:.2px; }
    .line{ height:1px; background: rgba(38,38,51,.8); margin:12px 0; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width: 140px; }

    label{ display:block; margin-top:10px; margin-bottom:6px; font-size:12px; color: var(--muted); }

    input, select, button, textarea{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(38,38,51,.95);
      background: rgba(15,15,18,.9);
      color: var(--text);
      padding: 11px 12px;
      font-size: 14px;
      outline: none;
    }
    textarea{ min-height: 70px; resize: vertical; }

    input:focus, select:focus, textarea:focus{
      border-color: rgba(124,92,255,.9);
      box-shadow: 0 0 0 3px rgba(124,92,255,.18);
    }

    button{
      cursor:pointer;
      border:none;
      font-weight:900;
      background: linear-gradient(135deg, var(--accent), #4c35ff);
      box-shadow: 0 10px 22px rgba(124,92,255,.18);
    }
    button.secondary{
      background: rgba(42,42,55,.75);
      border:1px solid rgba(70,70,90,.55);
      box-shadow:none;
    }
    button.ghost{
      background: transparent;
      border:1px solid rgba(70,70,90,.55);
      box-shadow:none;
    }
    button.danger{
      background: linear-gradient(135deg, #fb7185, #ef4444);
      box-shadow: 0 10px 22px rgba(239,68,68,.16);
    }

    .tiles{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .tile{
      background: rgba(15,15,18,.75);
      border: 1px solid rgba(38,38,51,.85);
      border-radius: 14px;
      padding: 12px;
    }
    .tile .k{ color: var(--muted); font-size:12px; }
    .tile .v{ font-weight: 900; font-size: 16px; margin-top:4px; }
    .tile .hint{ color: var(--muted); font-size: 11px; margin-top:6px; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

    /* Bottom Nav */
    .nav{
      position: fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(11,11,12,.88);
      backdrop-filter: blur(14px);
      border-top: 1px solid rgba(38,38,51,.75);
      z-index: 60;
    }
    .nav .bar{
      max-width:980px; margin:0 auto;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }
    .tab{
      padding: 10px 8px;
      border-radius: 14px;
      background: rgba(15,15,18,.7);
      border: 1px solid rgba(38,38,51,.8);
      color: var(--muted);
      font-size: 12px;
      font-weight: 900;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(124,92,255,.7);
      background: radial-gradient(160px 60px at 50% 0%, rgba(124,92,255,.25), transparent 70%), rgba(15,15,18,.85);
    }
    .ico{ font-size:16px; line-height:16px; }

    .currency{ font-variant-numeric: tabular-nums; letter-spacing:.2px; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(var(--navH) + env(safe-area-inset-bottom) + 10px);
      transform: translateX(-50%);
      background: rgba(17,17,22,.92);
      border: 1px solid rgba(38,38,51,.9);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--text);
      font-size: 12px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 80;
      max-width: 92vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .toast.show{ display:block; }

    /* Charts */
    canvas{
      width:100%;
      height:220px;
      background: rgba(15,15,18,.55);
      border: 1px solid rgba(38,38,51,.75);
      border-radius: 14px;
    }

    .list{
      margin:0; padding:0; list-style:none;
      display:flex; flex-direction:column; gap:8px;
    }
    .list li{
      background: rgba(15,15,18,.60);
      border: 1px solid rgba(38,38,51,.70);
      border-radius: 14px;
      padding: 10px 12px;
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .tag{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(70,70,90,.55);
      background: rgba(15,15,18,.75);
      color: var(--muted);
      white-space: nowrap;
    }
    .tag.paid{ border-color: rgba(45,212,191,.55); color: var(--accent2); }
    .tag.due{ border-color: rgba(251,191,36,.55); color: var(--warn); }
    .tag.late{ border-color: rgba(251,113,133,.55); color: var(--bad); }
  </style>
</head>
<body>

<div class="app">
  <header>
    <div class="headWrap">
      <div class="brand">
        <h1>Money OS</h1>
        <div class="sub">Optimized for iPhone ‚Ä¢ Charts ‚Ä¢ Obligations ‚Ä¢ Multi-card debt</div>
      </div>
      <div class="pill" id="miniStatus">Loading‚Ä¶</div>
    </div>
  </header>

  <main>
    <div class="wrap">

      <!-- HOME -->
      <section class="page active" id="page-home">
        <div class="grid">

          <div class="card">
            <h2>Snapshot <span class="pill" id="statusPill">‚Äî</span></h2>
            <div class="tiles">
              <div class="tile">
                <div class="k">Allowance</div>
                <div class="v" id="allowanceBig">$0.00</div>
                <div class="hint">Spending ceiling.</div>
              </div>
              <div class="tile">
                <div class="k">Bills</div>
                <div class="v" id="billsBig">$0.00</div>
                <div class="hint">Keep above floor.</div>
              </div>
              <div class="tile">
                <div class="k">Buffer</div>
                <div class="v" id="bufferBig">$0.00</div>
                <div class="hint">Protection only.</div>
              </div>
              <div class="tile">
                <div class="k">Trips</div>
                <div class="v" id="tripsBig">$0.00</div>
                <div class="hint">Experiences only.</div>
              </div>
            </div>

            <div class="line"></div>
            <div class="muted" id="nextAction">Next action: ‚Äî</div>
            <div class="muted small" id="homeNotes">‚Äî</div>

            <div class="line"></div>
            <button class="secondary" onclick="logSnapshot()">üì∏ Log Snapshot (for charts)</button>
            <div class="muted small" style="margin-top:8px;">Log once per day or per paycheck. Builds your progress charts.</div>
          </div>

          <div class="card">
            <h2>Quick Add</h2>
            <div class="muted">Type digits like Truist. 1234 ‚Üí $12.34</div>

            <div class="row" style="margin-top:10px;">
              <div>
                <label>Add to Bills</label>
                <input class="currency" id="addBills" inputmode="numeric" placeholder="$0.00">
                <button class="secondary" style="margin-top:10px;" onclick="quickAdd('bills')">Add</button>
              </div>
              <div>
                <label>Add to Trips</label>
                <input class="currency" id="addTrips" inputmode="numeric" placeholder="$0.00">
                <button class="secondary" style="margin-top:10px;" onclick="quickAdd('trips')">Add</button>
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <div>
                <label>Add to Buffer</label>
                <input class="currency" id="addBuffer" inputmode="numeric" placeholder="$0.00">
                <button class="secondary" style="margin-top:10px;" onclick="quickAdd('buffer')">Add</button>
              </div>
              <div>
                <label>Add to Allowance</label>
                <input class="currency" id="addAllow" inputmode="numeric" placeholder="$0.00">
                <button class="secondary" style="margin-top:10px;" onclick="quickAdd('allow')">Add</button>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Upcoming Payments</h2>
            <div class="muted small">Next 10 days from Obligations.</div>
            <div class="line"></div>
            <div id="homeUpcoming" class="small muted">No obligations added yet.</div>
            <div class="line"></div>
            <button class="secondary" onclick="showPage('obligations')">View Obligations</button>
          </div>

          <div class="card">
            <h2>Payday Script</h2>
            <div class="muted">Transfer guidance (doesn‚Äôt move money).</div>
            <div class="line"></div>
            <button onclick="runPaydayScript()">Run Payday Script</button>
          </div>

        </div>
      </section>

      <!-- ACTIONS -->
      <section class="page" id="page-actions">
        <div class="grid">
          <div class="card">
            <h2>Quick Actions</h2>
            <div class="muted">Buttons + Truist amount entry.</div>
            <div class="line"></div>
            <div class="row">
              <button onclick="actGotPaid()">üíµ Got Paid</button>
              <button class="secondary" onclick="actWindfall()">üí∞ Refund / Sale</button>
            </div>
            <div class="row" style="margin-top:10px;">
              <button class="secondary" onclick="actMoveMoney()">üîÅ Move Money</button>
              <button class="danger" onclick="actResetAllowance()">üóì Reset Allowance</button>
            </div>
            <div class="line"></div>
            <div class="row">
              <button class="secondary" onclick="actPayDebt()">üî• Pay Debt</button>
              <button class="secondary" onclick="actPayBill()">üßæ Pay Bill</button>
            </div>
            <div class="muted small" style="margin-top:10px;">
              Tip: When in doubt, windfalls ‚Üí Amex (highest APR).
            </div>
          </div>

          <div class="card">
            <h2>Safe to Spend?</h2>
            <label>Amount</label>
            <input class="currency" id="safeAmt" inputmode="numeric" placeholder="$0.00">
            <label>Type</label>
            <select id="safeType">
              <option value="allowance">Allowance (normal)</option>
              <option value="bills">Bills (essential only)</option>
              <option value="trips">Trips (travel)</option>
            </select>
            <div class="line"></div>
            <button class="secondary" onclick="checkSafe()">Check</button>
            <div class="line"></div>
            <div class="mono small" id="safeOut"></div>
          </div>
        </div>
      </section>

      <!-- TRIPS -->
      <section class="page" id="page-trips">
        <div class="grid">
          <div class="card">
            <h2>Trip Countdown</h2>
            <label>Trip date</label>
            <input id="tripDate" type="date">
            <div class="row">
              <div>
                <label>Trip target</label>
                <input class="currency" id="tripTarget" inputmode="numeric" placeholder="$0.00">
              </div>
              <div>
                <label>Pay cycle</label>
                <select id="payCycle">
                  <option value="biweekly">Biweekly</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
            </div>
            <div class="line"></div>
            <button class="secondary" onclick="updateTripPlan()">Update</button>
            <div class="line"></div>
            <div id="tripOut" class="small muted"></div>
          </div>

          <div class="card">
            <h2>Trip Fund Balance</h2>
            <div class="big" id="tripBig">$0.00</div>
            <div class="muted">Fund trips only after Bills + Buffer are safe.</div>
          </div>
        </div>
      </section>

      <!-- DEBT -->
      <section class="page" id="page-debt">
        <div class="grid">

          <div class="card">
            <h2>Debt Balances</h2>
            <div class="muted small">Enter each balance. Charts use these.</div>

            <label>Amex Gold</label>
            <input class="currency" id="amexGold" inputmode="numeric" placeholder="$0.00">

            <label>Amex Blue</label>
            <input class="currency" id="amexBlue" inputmode="numeric" placeholder="$0.00">

            <label>Apple Card</label>
            <input class="currency" id="appleCard" inputmode="numeric" placeholder="$0.00">

            <label>PayPal Credit Card</label>
            <input class="currency" id="paypalCC" inputmode="numeric" placeholder="$0.00">

            <label>Installments (Affirm/Pay-in-4/Apple installments)</label>
            <input class="currency" id="installments" inputmode="numeric" placeholder="$0.00">

            <div class="line"></div>
            <button class="secondary" onclick="saveDebt()">Save Debt</button>
          </div>

          <div class="card">
            <h2>Payoff Estimate</h2>
            <label>Highest APR (use Amex POT APR)</label>
            <input id="amexApr" inputmode="decimal" placeholder="28.49">

            <label>Extra per paycheck</label>
            <input class="currency" id="extraPerPaycheck" inputmode="numeric" placeholder="$0.00">

            <label>Strategy</label>
            <select id="debtStrategy">
              <option value="highest_first">Highest APR first (recommended)</option>
              <option value="installments_first">Installments first (mental relief)</option>
              <option value="split">Split 70/30</option>
            </select>

            <div class="line"></div>
            <button class="secondary" onclick="calcDebtPlan()">Calculate</button>
            <div class="line"></div>
            <div id="debtOut" class="small muted">Enter balances and calculate.</div>
          </div>

        </div>
      </section>

      <!-- OBLIGATIONS -->
      <section class="page" id="page-obligations">
        <div class="grid">
          <div class="card">
            <h2>Add Payment</h2>
            <div class="muted small">Track all monthly payments with dates + funding source.</div>

            <label>Description</label>
            <input id="oblDesc" placeholder="Insurance, Affirm, PayPal, etc.">

            <div class="row">
              <div>
                <label>Amount</label>
                <input class="currency" id="oblAmt" inputmode="numeric" placeholder="$0.00">
              </div>
              <div>
                <label>Due date</label>
                <input id="oblDate" type="date">
              </div>
            </div>

            <label>Pay from</label>
            <select id="oblFrom">
              <option value="bills">Bills</option>
              <option value="allow">Allowance</option>
              <option value="trips">Trips</option>
              <option value="buffer">Buffer (only emergencies)</option>
            </select>

            <div class="line"></div>
            <button class="secondary" onclick="addObligation()">Add</button>
            <button class="ghost" style="margin-top:10px;" onclick="clearObligations()">Clear All</button>
          </div>

          <div class="card">
            <h2>Upcoming</h2>
            <div class="muted small">Tap an item to mark Paid/Unpaid.</div>
            <div class="line"></div>
            <div id="oblList"></div>
          </div>
        </div>
      </section>

      <!-- ANALYSIS -->
      <section class="page" id="page-analysis">
        <div class="grid">

          <div class="card">
            <h2>Debt Breakdown</h2>
            <canvas id="chartDebt"></canvas>
            <div class="muted small" style="margin-top:8px;" id="debtLegend">‚Äî</div>
          </div>

          <div class="card">
            <h2>Monthly Expenses (planned)</h2>
            <canvas id="chartMonthly"></canvas>
            <div class="muted small" style="margin-top:8px;" id="monthlyLegend">‚Äî</div>
          </div>

          <div class="card">
            <h2>Progress Over Time</h2>
            <canvas id="chartProgress"></canvas>
            <div class="muted small" style="margin-top:8px;">Uses your logged snapshots.</div>
          </div>

          <div class="card">
            <h2>Snapshot Log</h2>
            <div class="muted small">Log snapshots on Home. You can clear history here if needed.</div>
            <div class="line"></div>
            <button class="secondary" onclick="clearSnapshots()">Clear Snapshot History</button>
          </div>

        </div>
      </section>

      <!-- WINS -->
      <section class="page" id="page-wins">
        <div class="grid">
          <div class="card">
            <h2>Impulse Wins</h2>
            <label>What you didn‚Äôt buy</label>
            <input id="winItem" placeholder="Amazon gadget, snacks, gear, etc.">
            <label>Amount avoided</label>
            <input class="currency" id="winAmt" inputmode="numeric" placeholder="$0.00">
            <div class="line"></div>
            <button class="secondary" onclick="logWin()">Log Win</button>
            <div class="line"></div>
            <div id="winsOut" class="small muted"></div>
            <div class="line"></div>
            <button class="ghost" onclick="clearWins()">Clear Wins</button>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section class="page" id="page-settings">
        <div class="grid">
          <div class="card">
            <h2>Targets</h2>
            <label>Weekly allowance</label>
            <input class="currency" id="weekly" inputmode="numeric" placeholder="$0.00">
            <label>Bills minimum (floor)</label>
            <input class="currency" id="billsMin" inputmode="numeric" placeholder="$0.00">
            <label>Bills ideal</label>
            <input class="currency" id="billsIdeal" inputmode="numeric" placeholder="$0.00">
            <label>Buffer target</label>
            <input class="currency" id="bufferTarget" inputmode="numeric" placeholder="$0.00">
            <label>Buffer floor</label>
            <input class="currency" id="bufferFloor" inputmode="numeric" placeholder="$0.00">
            <div class="line"></div>
            <button onclick="saveSettings()">Save Settings</button>
          </div>

          <div class="card">
            <h2>Balances</h2>
            <div class="muted">Set these once, then use Actions buttons going forward.</div>
            <div class="line"></div>
            <label>Bills</label>
            <input class="currency" id="bills" inputmode="numeric" placeholder="$0.00">
            <label>Allowance</label>
            <input class="currency" id="allow" inputmode="numeric" placeholder="$0.00">
            <label>Buffer</label>
            <input class="currency" id="buffer" inputmode="numeric" placeholder="$0.00">
            <label>Trips</label>
            <input class="currency" id="trips" inputmode="numeric" placeholder="$0.00">
            <div class="line"></div>
            <button class="secondary" onclick="saveBalances()">Save Balances</button>
          </div>
        </div>
      </section>

    </div>
  </main>

  <nav class="nav">
    <div class="bar">
      <div class="tab active" data-to="home"><div class="ico">üè†</div>Home</div>
      <div class="tab" data-to="actions"><div class="ico">‚ö°Ô∏è</div>Actions</div>
      <div class="tab" data-to="trips"><div class="ico">‚úàÔ∏è</div>Trips</div>
      <div class="tab" data-to="debt"><div class="ico">üî•</div>Debt</div>
      <div class="tab" data-to="obligations"><div class="ico">üìÖ</div>Pay</div>
      <div class="tab" data-to="analysis"><div class="ico">üìä</div>Charts</div>
      <div class="tab" data-to="settings"><div class="ico">‚öôÔ∏è</div>Settings</div>
    </div>
  </nav>

  <div class="toast" id="toast"></div>
</div>

<script>
  const LS = "money_os_v6";

  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 1400);
  }

  function load(){
    const d = JSON.parse(localStorage.getItem(LS) || "{}");
    return {
      billsCents: d.billsCents ?? 0,
      allowCents: d.allowCents ?? 0,
      bufferCents: d.bufferCents ?? 0,
      tripsCents: d.tripsCents ?? 0,

      weeklyCents: d.weeklyCents ?? 10000,
      billsMinCents: d.billsMinCents ?? 30000,
      billsIdealCents: d.billsIdealCents ?? 100000,
      bufferTargetCents: d.bufferTargetCents ?? 50000,
      bufferFloorCents: d.bufferFloorCents ?? 30000,

      tripDate: d.tripDate ?? "",
      tripTargetCents: d.tripTargetCents ?? 100000,
      payCycle: d.payCycle ?? "biweekly",

      // multi-card debt
      amexGoldCents: d.amexGoldCents ?? 0,
      amexBlueCents: d.amexBlueCents ?? 0,
      appleCardCents: d.appleCardCents ?? 0,
      paypalCCCents: d.paypalCCCents ?? 0,
      installmentsCents: d.installmentsCents ?? 0,

      amexApr: d.amexApr ?? 28.49,
      extraCents: d.extraCents ?? 0,
      debtStrategy: d.debtStrategy ?? "highest_first",

      wins: d.wins ?? [],
      obligations: d.obligations ?? [],
      snapshots: d.snapshots ?? []
    };
  }

  function save(patch){
    const d = load();
    const merged = {...d, ...patch};
    localStorage.setItem(LS, JSON.stringify(merged));
  }

  function centsToMoney(c){ return (c/100).toFixed(2); }
  function moneyStr(c){ return `$${centsToMoney(c)}`; }
  function digitsToCents(digits){
    const n = parseInt(digits || "0", 10);
    return isNaN(n) ? 0 : n;
  }

  // Truist-style currency input
  function attachCurrencyInput(el, initialCents=0){
    el.dataset.cents = String(initialCents);
    el.value = moneyStr(initialCents);

    el.addEventListener("keydown", (e)=>{
      const allowed = ["Backspace","Delete","ArrowLeft","ArrowRight","Tab"];
      if(allowed.includes(e.key)) return;

      if(e.key >= "0" && e.key <= "9"){
        e.preventDefault();
        const cur = el.dataset.cents || "0";
        const next = (cur === "0") ? e.key : (cur + e.key);
        el.dataset.cents = next;
        el.value = moneyStr(digitsToCents(next));
        return;
      }
      e.preventDefault();
    });

    el.addEventListener("paste", (e)=>{
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData("text") || "";
      const digits = text.replace(/\D/g,"");
      el.dataset.cents = digits || "0";
      el.value = moneyStr(digitsToCents(el.dataset.cents));
    });

    el.addEventListener("keyup", (e)=>{
      if(e.key === "Backspace" || e.key === "Delete"){
        const cur = el.dataset.cents || "0";
        const next = (cur.length <= 1) ? "0" : cur.slice(0, -1);
        el.dataset.cents = next;
        el.value = moneyStr(digitsToCents(next));
      }
    });
  }

  // Navigation
  function showPage(key){
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    $("page-"+key).classList.add("active");
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(`.tab[data-to="${key}"]`).forEach(t=>t.classList.add("active"));

    // redraw charts when entering analysis
    if(key === "analysis"){
      renderCharts();
    }
    if(key === "obligations"){
      renderObligations();
    }
    if(key === "wins"){
      renderWins();
    }
  }
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>showPage(t.dataset.to));
  });

  // ===== Core rendering =====
  function totalDebt(s){
    return s.amexGoldCents + s.amexBlueCents + s.appleCardCents + s.paypalCCCents + s.installmentsCents;
  }

  function renderHome(){
    const s = load();

    $("allowanceBig").textContent = moneyStr(s.allowCents);
    $("billsBig").textContent = moneyStr(s.billsCents);
    $("bufferBig").textContent = moneyStr(s.bufferCents);
    $("tripsBig").textContent = moneyStr(s.tripsCents);

    const dtotal = totalDebt(s);

    // Status
    let pill="ok", label="Stable";
    if(s.billsCents < s.billsMinCents || s.bufferCents < s.bufferFloorCents){ pill="bad"; label="Tight"; }
    else if(s.billsCents < s.billsIdealCents || s.bufferCents < s.bufferTargetCents){ pill="warn"; label="Caution"; }

    $("statusPill").className = `pill ${pill}`;
    $("statusPill").textContent = label;
    $("miniStatus").className = `pill ${pill}`;
    $("miniStatus").textContent = `${label} ‚Ä¢ Bills ${moneyStr(s.billsCents)} ‚Ä¢ Buffer ${moneyStr(s.bufferCents)} ‚Ä¢ Debt ${moneyStr(dtotal)}`;

    // Next best action
    let next="", note="";
    if(s.billsCents < s.billsMinCents){
      next="Add to Bills until above floor.";
      note="Bills floor prevents missed payments and panic moves.";
    } else if(s.bufferCents < s.bufferTargetCents){
      next="Rebuild Buffer toward target.";
      note="Buffer prevents reusing credit when timing gets weird.";
    } else if(s.amexGoldCents > 0){
      next="Attack Amex Gold first (highest APR).";
      note="Even small extra payments here reduce interest fastest.";
    } else if(s.installmentsCents > 0){
      next="Kill an installment plan (reduce random hits).";
      note="Installments are mental noise ‚Äî removing them improves cash flow predictability.";
    } else if(s.tripsCents < s.tripTargetCents){
      next="Fund Trips (after stability).";
      note="Trips are allowed when Bills+Buffer are safe.";
    } else {
      next="Maintain system. Keep it boring.";
      note="Boring money = winning money.";
    }
    $("nextAction").textContent = `Next action: ${next}`;
    $("homeNotes").textContent = note;

    // Home upcoming obligations summary
    const upcoming = getUpcomingObligations(10);
    if(upcoming.length === 0){
      $("homeUpcoming").textContent = "No obligations added yet.";
    } else {
      const lines = upcoming.slice(0,4).map(o => `${o.date} ‚Ä¢ ${o.desc} ‚Ä¢ ${moneyStr(o.cents)} ‚Ä¢ ${o.from}`);
      $("homeUpcoming").innerHTML = lines.map(x=>`‚Ä¢ ${x}`).join("<br/>") + (upcoming.length>4 ? "<br/><span class='muted'>‚Ä¶more in Obligations</span>" : "");
    }
  }

  // ===== Quick Add =====
  function quickAdd(which){
    const s = load();
    const map = { bills:"addBills", trips:"addTrips", buffer:"addBuffer", allow:"addAllow" };
    const el = $(map[which]);
    const cents = digitsToCents(el.dataset.cents || "0");
    if(cents <= 0) return toast("Enter an amount first.");

    if(which==="bills") save({ billsCents: s.billsCents + cents });
    if(which==="trips") save({ tripsCents: s.tripsCents + cents });
    if(which==="buffer") save({ bufferCents: s.bufferCents + cents });
    if(which==="allow") save({ allowCents: s.allowCents + cents });

    el.dataset.cents="0"; el.value="$0.00";
    toast(`Added ${moneyStr(cents)} to ${which}`);
    renderAll();
  }

  // ===== Payday script =====
  function runPaydayScript(){
    const s = load();
    const due10 = sumUpcomingCents(10);

    const billsNeedFloor = Math.max(0, (s.billsMinCents + due10) - s.billsCents);
    const billsNeedIdeal = Math.max(0, (s.billsIdealCents + due10) - s.billsCents);

    const bufNeedFloor = Math.max(0, s.bufferFloorCents - s.bufferCents);
    const bufNeedTarget = Math.max(0, s.bufferTargetCents - s.bufferCents);

    const allowNeed2w = Math.max(0, (s.weeklyCents*2) - s.allowCents);

    alert(
`PAYDAY SCRIPT

1) Bills first:
   ‚Ä¢ Cover next 10 days obligations: ${moneyStr(due10)}
   ‚Ä¢ To Bills floor:  ${moneyStr(billsNeedFloor)}
   ‚Ä¢ To Bills ideal:  ${moneyStr(billsNeedIdeal)}

2) Buffer:
   ‚Ä¢ To buffer floor: ${moneyStr(bufNeedFloor)}
   ‚Ä¢ To target:       ${moneyStr(bufNeedTarget)}

3) Allowance:
   ‚Ä¢ Refill 2 weeks:  ${moneyStr(allowNeed2w)}

4) Extra ‚Üí Highest APR debt ‚Üí installments ‚Üí trips
`
    );
  }

  // ===== Snapshot logging =====
  function logSnapshot(){
    const s = load();
    const snapshots = s.snapshots.slice();
    snapshots.push({
      ts: Date.now(),
      bills: s.billsCents,
      buffer: s.bufferCents,
      trips: s.tripsCents,
      debt: totalDebt(s)
    });
    save({ snapshots });
    toast("Snapshot logged");
    renderCharts();
  }

  function clearSnapshots(){
    if(!confirm("Clear snapshot history?")) return;
    save({ snapshots: [] });
    toast("Snapshots cleared");
    renderCharts();
  }

  // ===== Debt saving & planner =====
  function saveDebt(){
    const s = load();
    save({
      amexGoldCents: digitsToCents($("amexGold").dataset.cents || "0"),
      amexBlueCents: digitsToCents($("amexBlue").dataset.cents || "0"),
      appleCardCents: digitsToCents($("appleCard").dataset.cents || "0"),
      paypalCCCents: digitsToCents($("paypalCC").dataset.cents || "0"),
      installmentsCents: digitsToCents($("installments").dataset.cents || "0"),
    });
    toast("Debt saved");
    renderAll();
  }

  function calcDebtPlan(){
    const s = load();
    const apr = parseFloat($("amexApr").value || s.amexApr || "0");
    const extra = digitsToCents($("extraPerPaycheck").dataset.cents || "0");
    const strat = $("debtStrategy").value;

    save({ amexApr: apr, extraCents: extra, debtStrategy: strat });

    const amexTotal = s.amexGoldCents + s.amexBlueCents;
    const otherCards = s.appleCardCents + s.paypalCCCents;
    const inst = s.installmentsCents;

    const total = amexTotal + otherCards + inst;
    if(extra <= 0 || total <= 0){
      $("debtOut").textContent = "Enter debt balances + extra per paycheck.";
      return;
    }

    // conservative: 2 paychecks/month
    const extraMonthly = extra * 2;

    // Simple simulation:
    let months = 0;
    let amex = amexTotal;
    let cards = otherCards;
    let installments = inst;
    const r = (apr/100)/12;

    while((amex > 1 || cards > 1 || installments > 1) && months < 240){
      months++;

      // interest modeled on amex only (dominant)
      if(amex > 1 && r > 0) amex = Math.round(amex * (1 + r));

      if(strat === "highest_first"){
        // pay amex, then other cards, then installments
        let pay = extraMonthly;
        if(amex > 0){
          const p = Math.min(pay, amex); amex -= p; pay -= p;
        }
        if(pay > 0 && cards > 0){
          const p = Math.min(pay, cards); cards -= p; pay -= p;
        }
        if(pay > 0 && installments > 0){
          const p = Math.min(pay, installments); installments -= p; pay -= p;
        }
      } else if(strat === "installments_first"){
        let pay = extraMonthly;
        if(installments > 0){
          const p = Math.min(pay, installments); installments -= p; pay -= p;
        }
        if(pay > 0 && amex > 0){
          const p = Math.min(pay, amex); amex -= p; pay -= p;
        }
        if(pay > 0 && cards > 0){
          const p = Math.min(pay, cards); cards -= p; pay -= p;
        }
      } else {
        // split 70/30: 70% to amex/cards, 30% to installments
        let payA = Math.round(extraMonthly * 0.7);
        let payI = extraMonthly - payA;

        if(amex > 0){
          const p = Math.min(payA, amex); amex -= p; payA -= p;
        }
        if(payA > 0 && cards > 0){
          const p = Math.min(payA, cards); cards -= p; payA -= p;
        }
        if(installments > 0){
          const p = Math.min(payI, installments); installments -= p; payI -= p;
        }
      }
    }

    $("debtOut").innerHTML =
      `Extra per paycheck: <b>${moneyStr(extra)}</b> (‚âà ${moneyStr(extraMonthly)}/mo)<br>`+
      `Strategy: <b>${strat.replace("_"," ")}</b><br>`+
      `<div class="line"></div>`+
      `Estimated time (extra-only): <b>${months} months</b><br>`+
      `<span class="muted">Minimum payments shorten this. Charts show your progress once you log snapshots.</span>`;
  }

  // ===== Obligations =====
  function addObligation(){
    const desc = $("oblDesc").value.trim();
    const cents = digitsToCents($("oblAmt").dataset.cents || "0");
    const date = $("oblDate").value;
    const from = $("oblFrom").value;

    if(!desc || !date || cents <= 0){
      return alert("Enter description, amount, and date.");
    }

    const s = load();
    const obligations = s.obligations.slice();
    obligations.push({
      id: (crypto?.randomUUID?.() || String(Date.now()+Math.random())),
      desc,
      cents,
      date,
      from,
      paid: false
    });
    save({ obligations });

    $("oblDesc").value = "";
    $("oblAmt").dataset.cents = "0";
    $("oblAmt").value = "$0.00";
    $("oblDate").value = "";

    toast("Payment added");
    renderObligations();
    renderHome();
  }

  function clearObligations(){
    if(!confirm("Clear all obligations?")) return;
    save({ obligations: [] });
    toast("Cleared");
    renderObligations();
    renderHome();
  }

  function toggleObligation(id){
    const s = load();
    const obligations = s.obligations.map(o => o.id === id ? {...o, paid: !o.paid} : o);
    save({ obligations });
    renderObligations();
    renderHome();
  }

  function getUpcomingObligations(days){
    const s = load();
    const today = new Date(); today.setHours(0,0,0,0);
    const end = new Date(today); end.setDate(end.getDate()+days);

    return s.obligations
      .filter(o => {
        const od = new Date(o.date+"T00:00:00");
        return od >= today && od <= end;
      })
      .sort((a,b)=>a.date.localeCompare(b.date));
  }

  function sumUpcomingCents(days){
    const upcoming = getUpcomingObligations(days);
    return upcoming.filter(o=>!o.paid).reduce((acc,o)=>acc+o.cents,0);
  }

  function renderObligations(){
    const s = load();
    const list = s.obligations.slice().sort((a,b)=>a.date.localeCompare(b.date));
    const el = $("oblList");

    if(list.length === 0){
      el.innerHTML = "<div class='muted'>No payments added yet.</div>";
      return;
    }

    const today = new Date(); today.setHours(0,0,0,0);

    let html = `<ul class="list">`;
    for(const o of list){
      const od = new Date(o.date+"T00:00:00");
      let tagClass = "due";
      if(o.paid) tagClass = "paid";
      else if(od < today) tagClass = "late";

      html += `
        <li onclick="toggleObligation('${o.id}')">
          <div>
            <div><b>${o.date}</b> ‚Ä¢ ${escapeHtml(o.desc)}</div>
            <div class="muted small">${escapeHtml(o.from)} ‚Ä¢ ${moneyStr(o.cents)}</div>
          </div>
          <div class="tag ${tagClass}">${o.paid ? "PAID" : (od < today ? "LATE" : "DUE")}</div>
        </li>
      `;
    }
    html += `</ul>`;
    el.innerHTML = html;
  }

  // ===== Charts =====
  function drawDonut(canvas, parts){
    // parts: [{label, value, color}]
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth * devicePixelRatio;
    const h = canvas.height = canvas.clientHeight * devicePixelRatio;
    ctx.clearRect(0,0,w,h);

    const total = parts.reduce((a,p)=>a+p.value,0) || 1;
    const cx = w/2, cy = h/2;
    const r = Math.min(w,h)*0.35;
    const thickness = r*0.45;

    let start = -Math.PI/2;
    for(const p of parts){
      const frac = p.value/total;
      const end = start + frac*2*Math.PI;
      ctx.strokeStyle = p.color;
      ctx.lineWidth = thickness;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.arc(cx, cy, r, start, end);
      ctx.stroke();
      start = end;
    }

    // center label
    ctx.fillStyle = "rgba(242,242,242,.92)";
    ctx.font = `${Math.round(18*devicePixelRatio)}px -apple-system, system-ui, Segoe UI, Roboto, Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("Debt", cx, cy - 10*devicePixelRatio);
    ctx.fillStyle = "rgba(182,182,194,.9)";
    ctx.font = `${Math.round(14*devicePixelRatio)}px -apple-system, system-ui, Segoe UI, Roboto, Arial`;
    ctx.fillText("Breakdown", cx, cy + 14*devicePixelRatio);
  }

  function drawBar(canvas, rows){
    // rows: [{label, value, color}]
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth * devicePixelRatio;
    const h = canvas.height = canvas.clientHeight * devicePixelRatio;
    ctx.clearRect(0,0,w,h);

    const max = Math.max(...rows.map(r=>r.value), 1);
    const pad = 18*devicePixelRatio;
    const barH = 18*devicePixelRatio;
    const gap = 14*devicePixelRatio;

    let y = pad;
    ctx.font = `${Math.round(12*devicePixelRatio)}px -apple-system, system-ui, Segoe UI, Roboto, Arial`;
    ctx.textBaseline = "middle";

    for(const r of rows){
      const bw = (w - pad*2) * (r.value / max);

      // label
      ctx.fillStyle = "rgba(182,182,194,.9)";
      ctx.textAlign = "left";
      ctx.fillText(r.label, pad, y);

      // value
      ctx.textAlign = "right";
      ctx.fillText(`$${(r.value/100).toFixed(0)}`, w-pad, y);

      // bar
      y += 12*devicePixelRatio;
      ctx.fillStyle = "rgba(38,38,51,.65)";
      ctx.fillRect(pad, y, w-pad*2, barH);
      ctx.fillStyle = r.color;
      ctx.fillRect(pad, y, bw, barH);

      y += barH + gap;
      if(y > h - pad) break;
    }
  }

  function drawLine(canvas, points){
    // points: [{x: ts, y: valueCents}]
    const ctx = canvas.getContext("2d");
    const w = canvas.width = canvas.clientWidth * devicePixelRatio;
    const h = canvas.height = canvas.clientHeight * devicePixelRatio;
    ctx.clearRect(0,0,w,h);

    if(points.length < 2){
      ctx.fillStyle = "rgba(182,182,194,.9)";
      ctx.font = `${Math.round(14*devicePixelRatio)}px -apple-system, system-ui, Segoe UI, Roboto, Arial`;
      ctx.textAlign="center"; ctx.textBaseline="middle";
      ctx.fillText("Log 2+ snapshots to see progress", w/2, h/2);
      return;
    }

    const pad = 18*devicePixelRatio;
    const xs = points.map(p=>p.x);
    const ys = points.map(p=>p.y);

    const xmin = Math.min(...xs), xmax = Math.max(...xs);
    const ymin = Math.min(...ys), ymax = Math.max(...ys);
    const yr = Math.max(1, ymax - ymin);

    function px(x){ return pad + (w - pad*2) * ((x - xmin) / (xmax - xmin)); }
    function py(y){ return (h - pad) - (h - pad*2) * ((y - ymin) / yr); }

    // grid line
    ctx.strokeStyle = "rgba(38,38,51,.8)";
    ctx.lineWidth = 1*devicePixelRatio;
    ctx.beginPath();
    ctx.moveTo(pad, py(ymin));
    ctx.lineTo(w-pad, py(ymin));
    ctx.stroke();

    // line
    ctx.strokeStyle = "rgba(124,92,255,.95)";
    ctx.lineWidth = 3*devicePixelRatio;
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(px(points[0].x), py(points[0].y));
    for(const p of points.slice(1)){
      ctx.lineTo(px(p.x), py(p.y));
    }
    ctx.stroke();

    // end dot
    const last = points[points.length-1];
    ctx.fillStyle = "rgba(45,212,191,.95)";
    ctx.beginPath();
    ctx.arc(px(last.x), py(last.y), 4*devicePixelRatio, 0, Math.PI*2);
    ctx.fill();

    // labels
    ctx.fillStyle = "rgba(182,182,194,.9)";
    ctx.font = `${Math.round(12*devicePixelRatio)}px -apple-system, system-ui, Segoe UI, Roboto, Arial`;
    ctx.textAlign="left";
    ctx.fillText(`Debt: $${(last.y/100).toFixed(0)}`, pad, pad);
  }

  function renderCharts(){
    const s = load();

    // Debt donut
    const parts = [
      {label:"Amex Gold", value:s.amexGoldCents, color:"rgba(124,92,255,.95)"},
      {label:"Amex Blue", value:s.amexBlueCents, color:"rgba(45,212,191,.95)"},
      {label:"Apple Card", value:s.appleCardCents, color:"rgba(251,191,36,.95)"},
      {label:"PayPal CC", value:s.paypalCCCents, color:"rgba(251,113,133,.95)"},
      {label:"Installments", value:s.installmentsCents, color:"rgba(148,163,184,.95)"}
    ];
    drawDonut($("chartDebt"), parts);

    $("debtLegend").innerHTML =
      parts.map(p=>`‚Ä¢ ${p.label}: <b>${moneyStr(p.value)}</b>`).join("<br/>");

    // Monthly planned expenses bar
    // Planned = fixed targets + upcoming obligations next 30 (rough)
    const fixedRows = [
      {label:"Auto", value:70000, color:"rgba(124,92,255,.85)"},
      {label:"Insurance", value:21300, color:"rgba(45,212,191,.85)"},
      {label:"Phone", value:15000, color:"rgba(251,191,36,.85)"},
      {label:"Dog", value:10000, color:"rgba(148,163,184,.85)"},
    ];
    // Include obligations count (unpaid) this month as a bar:
    const upcoming30 = sumUpcomingCents(30);
    fixedRows.push({label:"Upcoming payments", value: upcoming30, color:"rgba(251,113,133,.85)"});

    drawBar($("chartMonthly"), fixedRows);
    $("monthlyLegend").innerHTML =
      fixedRows.map(r=>`‚Ä¢ ${r.label}: <b>${moneyStr(r.value)}</b>`).join("<br/>");

    // Progress chart (debt over time)
    const pts = (s.snapshots || []).map(x=>({x:x.ts, y:x.debt}));
    drawLine($("chartProgress"), pts);
  }

  // ===== Safe to spend =====
  function checkSafe(){
    const s = load();
    const amt = digitsToCents($("safeAmt").dataset.cents || "0");
    const type = $("safeType").value;
    if(amt <= 0) return $("safeOut").textContent = "Enter an amount.";

    const due10 = sumUpcomingCents(10);

    let ok=true, notes=[];
    if(type==="allowance"){
      if(s.allowCents < amt){ ok=false; notes.push("Allowance insufficient."); }
      if((s.billsCents - due10) < s.billsMinCents) notes.push("Bills after upcoming payments is below floor (heads-up).");
    } else if(type==="bills"){
      if((s.billsCents - due10 - amt) < s.billsMinCents){ ok=false; notes.push("Bills would drop below floor after upcoming payments."); }
    } else if(type==="trips"){
      if(s.tripsCents < amt){ ok=false; notes.push("Trips fund insufficient."); }
    }
    $("safeOut").textContent = (ok ? "‚úÖ SAFE" : "‚ùå NOT SAFE") + (notes.length ? ("\n‚Ä¢ "+notes.join("\n‚Ä¢ ")) : "");
  }

  // ===== Trip =====
  function updateTripPlan(){
    const s = load();
    const date = $("tripDate").value;
    const target = digitsToCents($("tripTarget").dataset.cents || "0");
    const cycle = $("payCycle").value;

    save({ tripDate: date, tripTargetCents: target, payCycle: cycle });

    if(!date || target<=0){
      $("tripOut").textContent = "Set a trip date and target.";
      return;
    }

    const now = new Date(); now.setHours(0,0,0,0);
    const td = new Date(date+"T00:00:00");
    const days = Math.max(0, Math.ceil((td-now)/(1000*60*60*24)));
    const remaining = Math.max(0, target - s.tripsCents);

    let periods=1;
    if(cycle==="weekly") periods = Math.max(1, Math.ceil(days/7));
    if(cycle==="biweekly") periods = Math.max(1, Math.ceil(days/14));
    if(cycle==="monthly") periods = Math.max(1, Math.ceil(days/30));

    const perPeriod = Math.ceil(remaining/periods);
    const perWeek = Math.ceil(remaining/Math.max(1,Math.ceil(days/7)));

    $("tripOut").innerHTML =
      `Trips balance: <b>${moneyStr(s.tripsCents)}</b><br>`+
      `Target: <b>${moneyStr(target)}</b> ‚Ä¢ Remaining: <b>${moneyStr(remaining)}</b><br>`+
      `Days until trip: <b>${days}</b><br>`+
      `<div class="line"></div>`+
      `Needed per week: <b>${moneyStr(perWeek)}</b><br>`+
      `Needed per ${cycle}: <b>${moneyStr(perPeriod)}</b>`;
    $("tripBig").textContent = moneyStr(s.tripsCents);
  }

  // ===== Actions =====
  function promptCents(label){
    const raw = prompt(label + " (type digits like Truist: 1234 = $12.34)");
    if(raw === null) return null;
    const digits = raw.replace(/\D/g,"");
    const cents = digitsToCents(digits);
    if(cents <= 0) { alert("Enter a valid amount."); return null; }
    return cents;
  }

  function actGotPaid(){
    const cents = promptCents("Paycheck amount received");
    if(cents === null) return;
    const s = load();
    save({ billsCents: s.billsCents + cents });
    toast("Paycheck added to Bills");
    renderAll();
  }

  function actWindfall(){
    const cents = promptCents("Refund / sale amount received");
    if(cents === null) return;
    const choice = prompt("Where should it go? 1=Debt (default) 2=Buffer 3=Trips 4=Bills");
    const s = load();

    if(choice === "2") save({ bufferCents: s.bufferCents + cents });
    else if(choice === "3") save({ tripsCents: s.tripsCents + cents });
    else if(choice === "4") save({ billsCents: s.billsCents + cents });
    else {
      // default: reduce Amex Gold first
      const newGold = Math.max(0, s.amexGoldCents - cents);
      save({ amexGoldCents: newGold });
    }

    toast("Windfall logged");
    renderAll();
  }

  function actMoveMoney(){
    const cents = promptCents("How much are you moving");
    if(cents === null) return;

    const from = (prompt("Move FROM: bills / allow / buffer / trips")||"").trim().toLowerCase();
    const to = (prompt("Move TO: bills / allow / buffer / trips")||"").trim().toLowerCase();

    const s = load();
    const map = { bills:"billsCents", allow:"allowCents", buffer:"bufferCents", trips:"tripsCents" };
    if(!map[from] || !map[to] || from===to) return alert("Invalid from/to.");
    if(s[map[from]] < cents) return alert("Not enough in " + from);

    const patch = {};
    patch[map[from]] = s[map[from]] - cents;
    patch[map[to]] = s[map[to]] + cents;
    save(patch);
    toast(`Moved ${moneyStr(cents)} ${from} ‚Üí ${to}`);
    renderAll();
  }

  function actResetAllowance(){
    const s = load();
    save({ allowCents: s.weeklyCents });
    toast("Allowance reset");
    renderAll();
  }

  function actPayDebt(){
    const cents = promptCents("Debt payment amount (defaults to Amex Gold)");
    if(cents === null) return;
    const s = load();
    save({ amexGoldCents: Math.max(0, s.amexGoldCents - cents) });
    toast("Debt logged");
    renderAll();
  }

  function actPayBill(){
    const cents = promptCents("Bill paid amount (reduces Bills balance)");
    if(cents === null) return;
    const s = load();
    save({ billsCents: Math.max(0, s.billsCents - cents) });
    toast("Bill logged");
    renderAll();
  }

  // ===== Wins =====
  function logWin(){
    const item = $("winItem").value.trim();
    const cents = digitsToCents($("winAmt").dataset.cents || "0");
    if(!item || cents<=0) return alert("Add an item and amount.");
    const s = load();
    const wins = s.wins.slice();
    wins.unshift({ item, cents, ts: Date.now() });
    save({ wins });
    $("winItem").value="";
    $("winAmt").dataset.cents="0";
    $("winAmt").value="$0.00";
    renderWins();
    toast("Win logged");
  }

  function clearWins(){
    if(!confirm("Clear all wins?")) return;
    save({ wins: [] });
    renderWins();
  }

  function renderWins(){
    const s = load();
    const wins = s.wins || [];
    if(!wins.length){ $("winsOut").textContent="No wins yet."; return; }

    const now = Date.now();
    const weekAgo = now - 7*24*3600*1000;
    let week=0, total=0;
    for(const w of wins){
      total += w.cents;
      if(w.ts >= weekAgo) week += w.cents;
    }

    let html = `<div class="big">${moneyStr(week)} <span class="muted">saved (7d)</span></div>`;
    html += `<div class="muted">All-time: ${moneyStr(total)}</div>`;
    html += `<ul>`;
    for(const w of wins.slice(0,10)){
      html += `<li><b>${moneyStr(w.cents)}</b> ‚Äî ${escapeHtml(w.item)}</li>`;
    }
    html += `</ul>`;
    $("winsOut").innerHTML = html;
  }

  // ===== Settings =====
  function saveSettings(){
    const weekly = digitsToCents($("weekly").dataset.cents || "0");
    const billsMin = digitsToCents($("billsMin").dataset.cents || "0");
    const billsIdeal = digitsToCents($("billsIdeal").dataset.cents || "0");
    const bufTarget = digitsToCents($("bufferTarget").dataset.cents || "0");
    const bufFloor = digitsToCents($("bufferFloor").dataset.cents || "0");

    save({
      weeklyCents: weekly,
      billsMinCents: billsMin,
      billsIdealCents: billsIdeal,
      bufferTargetCents: bufTarget,
      bufferFloorCents: bufFloor
    });
    toast("Settings saved");
    renderAll();
  }

  function saveBalances(){
    const bills = digitsToCents($("bills").dataset.cents || "0");
    const allow = digitsToCents($("allow").dataset.cents || "0");
    const buffer = digitsToCents($("buffer").dataset.cents || "0");
    const trips = digitsToCents($("trips").dataset.cents || "0");

    save({ billsCents: bills, allowCents: allow, bufferCents: buffer, tripsCents: trips });
    toast("Balances saved");
    renderAll();
  }

  // ===== Bind inputs once =====
  function bindAllCurrency(){
    const s = load();
    const map = {
      addBills: 0, addTrips: 0, addBuffer: 0, addAllow: 0,
      safeAmt: 0,
      tripTarget: s.tripTargetCents,
      amexGold: s.amexGoldCents,
      amexBlue: s.amexBlueCents,
      appleCard: s.appleCardCents,
      paypalCC: s.paypalCCCents,
      installments: s.installmentsCents,
      extraPerPaycheck: s.extraCents,
      winAmt: 0,
      weekly: s.weeklyCents,
      billsMin: s.billsMinCents,
      billsIdeal: s.billsIdealCents,
      bufferTarget: s.bufferTargetCents,
      bufferFloor: s.bufferFloorCents,
      bills: s.billsCents,
      allow: s.allowCents,
      buffer: s.bufferCents,
      trips: s.tripsCents,
      oblAmt: 0
    };

    Object.keys(map).forEach(id=>{
      const el = $(id);
      if(!el) return;
      if(el.dataset.bound === "1") return;
      el.dataset.bound="1";
      attachCurrencyInput(el, map[id] ?? 0);
    });

    // Non-currency binds
    if(!$("tripDate").dataset.bound){
      $("tripDate").dataset.bound="1";
      $("tripDate").value = s.tripDate || "";
      $("payCycle").value = s.payCycle || "biweekly";
      $("amexApr").value = s.amexApr ?? 28.49;
      $("debtStrategy").value = s.debtStrategy ?? "highest_first";
    }
  }

  // ===== Render all =====
  function renderAll(){
    bindAllCurrency();
    renderHome();
    renderWins();
    renderObligations();
    updateTripPlan();
    renderCharts();
  }

  // ===== Analysis initial placeholder charts on load =====
  // (charts render from stored values; no external libraries)

  // Init
  (function init(){
    const d = JSON.parse(localStorage.getItem(LS) || "{}");
    if(Object.keys(d).length === 0){
      save(load()); // seed defaults
    }
    renderAll();
  })();

  // Minor helper
  function escapeHtml(s){ return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

</script>

</body>
</html>
